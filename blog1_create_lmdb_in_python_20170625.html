<!DOCTYPE HTML>
<html>
<head>
    <title>Blog-Yan Song</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="keywords" content="LMDB, PYTHON, Datum" />
    <meta name="author" content="Yan Song" />
    <link rel="stylesheet" href="assets/css/main.css" />
</head>

<body>
    <div class="page-wrap">
        <!-- Nav -->
        <nav id="nav">
          <ul>
	      <li><a href="index.html"><span class="icon fa-home"></span></a></li>
	<!--
              <li><a href="gallery.html"><span class="icon fa-camera-retro"></span></a></li>
              <li><a href="generic.html" class="active"><span class="icon fa-file-text-o"></span></a></li>
        -->
	  </ul>
	</nav>
        <!-- end Nav -->

        <!-- Main -->
	<section id="main">
	   <!-- Header -->
	    <header id="header">
	        <div><span>by Yan Song</span></div>
	    </header>
           <!-- end Header -->

	   <!-- Section -->
	    <section>
                <div class="inner">
		    <div align="center">
		    <header><h1>How To Create LMDB in PYTHON</h1></header>
		    <p>
                        LMDB:&nbsp;&nbsp;&nbsp;<span><b>L</b>ightning <b>M</b>emory-<b>M</b>apped <b>D</b>atabase</span>
		        <br>								
		        LMDB provides key-value storage, key is a string version of an ID, while value is a serialized version of Datum object.
		    </p>
                    </div>

		    <!-- double column-->
                    <div style="margin-top: 0; margin-left: 7%; margin-right: 7%;">
		        <hr>
		        <section class="columns double">
                            <!-- left colum -->
			    <div class="column" style="border-right: 1px solid;">
			        <p>
				  	<font color="#15b5cb"># create and write a LMDB file</font><br>
					<font color="#489f1f">import</font>&nbsp;<font color="#1f4f9f">numpy</font>&nbsp;<font color="#489f1f">as</font>&nbsp;<font color="#1f4f9f">np</font><br>
					<font color="#489f1f">import</font>&nbsp;<font color="#1f4f9f">lmdb</font><br>
					<font color="#489f1f">import</font>&nbsp;<font color="#1f4f9f">sys</font><br>
					caffe_root = <font color="#9f1f2b">'/home/yan/caffe'</font><br>
					sys.path.insert(0, caffe_root + <font color="#9f1f2b">'python'</font>)<br>
					<font color="#489f1f">import</font>&nbsp;<font color="#1f4f9f">caffe</font><br>
					<br>
					N = 1000<br>
					X = np.zeros((N, 3, 3, 1), dtype=np.float32)<br>
					y = np.zeros(N, dtype=np.float32)<br>
					map_size = X.nbytes * 10  <font color="#15b5cb"># required size for database</font><br>
					<br>
					env = lmdb.open(<font color="#9f1f2b">'train_lmdb'</font>, map_size = map_size)<br>
					<br>
					<font color="#489f1f">with</font>&nbsp;&nbsp;env.begin(write=<font color="#489f1f">True</font>)&nbsp;&nbsp;<font color="#489f1f">as</font>&nbsp;&nbsp;txn:  <br>
					&nbsp;&nbsp;&nbsp;&nbsp;<font color="#15b5cb"># txn is a Transaction object<br></font>
					&nbsp;&nbsp;&nbsp;&nbsp;<font color="#489f1f">for</font>&nbsp;&nbsp;i&nbsp;&nbsp;<font color="#9115cb">in</font>&nbsp;&nbsp;<font color="#489f1f">range</font>(N):<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum = caffe.proto.caffe_pb2.Datum()<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum.channels = X.shape[1]<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum.height = X.shape[2]<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum.width = X.shape[3]<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum.data = X[i].tobytes()  <font color="#15b5cb"># or .tostring() if numpy &lt; 1.9</font> <br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;datum.label = <font color="#489f1f">int</font>(y[i])<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_id = <font color="#9f1f2b">'{:08}'</font>.format(i)<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;txn.put(str_id.encode(<font color="#9f1f2b">'ascii'</font>), datum.SerializeToString())<br>
                                </p>
			    </div>
                            <!-- right column -->
		            <div class="column">
			        <p> 
                                        <font color="#15b5cb"># read an existing LMDB file<br></font>
					<font color="#489f1f">import</font>&nbsp;numpy&nbsp;&nbsp;<font color="#489f1f">as</font>&nbsp;&nbsp;np<br>
					<font color="#489f1f">import</font>&nbsp;&nbsp;lmdb<br>
					<font color="#489f1f">import</font>&nbsp;&nbsp;caffe<br>
					env = lmdb.open('train_lmdb', readonly=True)<br>
					<font color="#489f1f">with</font>&nbsp;&nbsp;env.begin()&nbsp;&nbsp;<font color="#489f1f">as</font>&nbsp;&nbsp;txn:<br>
					&nbsp;&nbsp;&nbsp;&nbsp;<font color="#15b5cb"> # txn.get('somekey')  key = '00000000'  (Bytes literals)</font><br>
					&nbsp;&nbsp;&nbsp;&nbsp;raw_datum = txn.get(<font color="#9f1f2b">b'00000000'</font>)<br> 
					<br>
					datum = caffe.proto.caffe_pb2.Datum()<br>
					datum.ParseFromString(raw_datum)<br>
					flat_x = np.fromstring(datum.data, dtype=np.float32)<br>
					x = flat_x.reshape(datum.channels, datum.height, datum.width)<br>
					y = datum.label<br>
					<br>
					<font color="#15b5cb"># Iterating &lt;key, value&gt; paris <br></font>
					<font color="#489f1f">with</font>&nbsp;&nbsp;env.begin()&nbsp;&nbsp;<font color="#489f1f">as</font>&nbsp;&nbsp;txn:<br>
					&nbsp;&nbsp;&nbsp;&nbsp;cursor = txn.cursor()<br>
					&nbsp;&nbsp;&nbsp;&nbsp;<font color="#489f1f">for</font>&nbsp;&nbsp;key, value&nbsp;&nbsp;<font color="#9115cb">in</font>&nbsp;&nbsp;cursor:<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#489f1f">print</font>&nbsp;&nbsp;(key, value)<br>
					&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#15b5cb"># here value is a serialized version of Datum</font><br>
                                </p>
		            </div>
		        </section>
                    </div>
                    <!-- end double column -->

                    <!-- some functions and classes -->
                    <div style="margin-top: 0; margin-left: 7%; margin-right: 7%;">
		        <hr>
	                <h2> Some functions and classes </h2>
			1) <b>lmdb.open(path, **kwargs)</b>
			<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="#15b5cb">Shortcut for Environment constructor.</font>
			<br>
			2) <b>class lmdb.Environment</b>(path, map_size=10485760, subdir=True, readonly=False, ...)
			<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Environment class</b><br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Structure for a database environment.<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;An environment may contain multiple databases, all residing in the same shared-memory map and underlying disk file.
			</font>
			<br>
			3) <b>env.begin()</b>
			<br>
			<font color="#15b5cb">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Return a Transaction object.</font>
			<br>
			4) <b>class lmdb.Transaction</b>(env, db=None, parent=None, write=False, buffers=False)
			<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<b>Transaction class</b>
			<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A transaction object. <br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;All operations require a transaction handle, transactions may be read-only or read-write.
			</font>
			<br>
			5) <b>txn.put</b>(key, value, dupdata=True, overwrite=True, append=False, db=None)
			<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Store a record, returning True if it was written, or False to indicate the key was already present and overwrite=False. <br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;On success, the cursor is positioned on the new record.
			</font>
			<br>
			6) <b>txn.get</b>('somekey')
			<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in LMDB the format is &lt;key, value&gt;<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;key is a String version of an ID<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value is a serialized version of Datum
			</font>
			<br>
			7) <b>Datum Class</b>
			<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Datum is a Google Protobuf Message class used to store data and optionally a label.<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;A Datum can be thought of a as a matrix with three dimensions: width, height, and channel<br>
			</font>
			&nbsp;&nbsp;&nbsp;&nbsp;message Datum { <br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;optional&nbsp;<font color="#489f1f">int32</font>&nbsp;channels = 1;<br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;optional&nbsp;<font color="#489f1f">int32</font>&nbsp;height = 2;<br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;optional&nbsp;<font color="#489f1f">int32</font>&nbsp;width = 3;<br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<b>optional&nbsp;<font color="#489f1f">bytes</font>&nbsp;data</b> = 4;<br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;<b>optional&nbsp;<font color="#489f1f">int32</font>&nbsp;label</b> = 5; 
			    <font color="#15b5cb"> # lable is int type</font><br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;repeated&nbsp;<font color="#489f1f">float</font>&nbsp;float_data = 6;<br>
			    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;optional&nbsp;<font color="#489f1f">bool</font>&nbsp;encoded = 7 [default=false] ;<br>
			&nbsp;&nbsp;&nbsp;&nbsp;}<br>
			<font color="#15b5cb">
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;data could be stored as <font color="#489f1f">int</font> data or <font color="#489f1f">float</font> data; <br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;usually IMAGE data is in byte_data, while feature matrix data is in float_data;<br>
			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;some data needs to be encoded;<br>
			</font>
                    </div>
                    <!-- end some functions and classes -->

		    <!-- Footer -->
		    <footer id="footer">
		        <div class="copyright">--- 2017.06.25 ---</div>
                    </footer>
                   <!-- end Footer -->
                </div>
            </section>
            <!-- end Section -->
	</section>
        <!-- end Main -->
   </div>
	<!-- Scripts -->
	<script src="assets/js/jquery.min.js"></script>
	<script src="assets/js/jquery.poptrox.min.js"></script>
	<script src="assets/js/jquery.scrolly.min.js"></script>
	<script src="assets/js/skel.min.js"></script>
	<script src="assets/js/util.js"></script>
	<script src="assets/js/main.js"></script>
</body>
</html>
